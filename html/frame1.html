<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
  <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
  <title>彩票房间</title>
  <link rel="stylesheet" type="text/css" href="../css/api.css"/>
  <link rel="stylesheet" type="text/css" href="../css/style.css"/>
  <style>
     .appends{
          width:25%;height:8rem;
          position:absolute;background:#fff;z-index:666;
          /*border:0.1rem solid #D2D2D2;*/

          display: none
          /*border-radius:0.2rem solid #D2D2D2;*/
        }
        .appends ul li{
          height: 3.6rem;
          line-height: 3.6rem;
          font-size: 1.4rem;
          padding: 0 10%;
          border-bottom: 0.1rem solid #fafafa;
        }


    html{
      font-size: 10px;
    }
    /*tab css样式*/
    #tab_nav{
      float: left;
      width: 100%;
      background: #fff;
      display: flex;
    }
    #tab_nav li{
      flex: 1;
      text-align: center;
      float: left;
      width:50%;
    }
    #tab_nav li a{
      font-size: 1.4rem;
      color: #333333;
      width: 100%;
      /*width:50%;*/
      padding-top: 1.7rem;
      padding-bottom: 1.7rem;
      text-align: center;
      text-decoration: none;
    }
    .tab_nav_active{
      border-bottom: 1px solid #d71d34;
    }

    /*话题样式*/
    #tab_content,#activity{
      float: left;
      width: 100%;
      background: #f5f5f5;
      border-top: 0.5rem solid #EFEFEF;

    }
    /*活动样式*/
   .tab_ul{
     width: 100%;
     display: block;
   }
   .tab_ul li{
     width: 100%;
     height: 7rem;
     border-bottom: 1px solid #efefef;
   }
   .tab_ul .picture{
      float: left;
      width: 20%;
      height: 7rem;
   }
   .picture img{
     width: 5rem;
     height: 5rem;
     display: block;
     margin-top: 1rem;
     margin-left: 1.5rem;
     border-radius: 2.5rem;
   }
     .tab_ul .headline{
       float: left;
       width: 60%;
       height: 7rem;
     }
     .headline_title{
       padding-top: 1.5rem;
        font-size: 1.4rem;
     }
    .tab_ul .headline .headline_time{
       display: block;
       padding-top: 1rem;
       font-size: 1.2rem;
     }
    body{
      background:#f5f5f5 !important;
    }
    .nolist{
      background: #f5f5f5;
      text-align: center;
      color:#c0c0c0;
      font-size: 1.25rem;
    }
    .nolist img{
      margin:10rem auto;
      width:8.6rem;
      height:8.6rem;
    }
    .nolist .createBtn{
      border:1px solid #c0c0c0;
      color:#c0c0c0;
      margin-top:1.5rem;
      width:7.2rem;
      line-height: 2.8rem;
      height:2.8rem;
      margin:1.5rem auto;
    }
    body {
       position:relative;
    }
    .border{
      /*border-radius:5px;*/
    }

  </style>
</head>
<body>
  <div class="appends"></div>
  <ul id="tab_nav">
    <li class="tab_change tab_nav_active"><a href="#" class="tab_nav_a">彩票</a></li>
    <li class="tab_change"><a href="#" class="tab_nav_a">游戏</a></li>
  </ul>
  <section id="tab_content">
    <!-- 彩票房间 -->
    <ul class="tab_ul tab_ulLott" style="display:none">

      <!-- <li class="roomDetail roomlottery">
           <div class="picture"><img src="../image/discover/activity_02.png" alt=""></div>
           <div class="headline">
              <div class="headline_title">房间:0014567</div>
              <span class="headline_time">类型:双色彩</span>
           </div>
      </li>
      <li class="roomDetail roomlottery">
           <div class="picture"><img src="../image/discover/activity_02.png" alt=""></div>
           <div class="headline">
              <div class="headline_title">房间:004567</div>
              <span class="headline_time">类型:3D</span>
           </div>
      </li> -->
    </ul>
    <div class="nolist nolist1" style="display:none">
      <img src="../image/createRoom/tu_wufangjian.png" alt="">
      <p>暂无房间，请创建新房间</p>
      <p class="createBtn"  id="createLottery"  onclick="createRoom()">创建</p>
    </div>
  </section>
  <section id="activity">
    <!-- 游戏房间 -->
    <ul class="tab_ul tab_ulGame"  style="display:none">

      <!-- <li class="roomDetail roomgame">
           <div class="picture"><img src="../image/discover/activity_02.png" alt=""></div>
           <div class="headline">
              <div class="headline_title">房间:098574</div>
              <span class="headline_time">类型:牛牛</span>
           </div>
      </li>
      <li class="roomDetail roomgame">
           <div class="picture"><img src="../image/discover/activity_02.png" alt=""></div>
           <div class="headline">
              <div class="headline_title">房间:098574</div>
              <span class="headline_time">类型:小牛</span>
           </div>
      </li> -->
    </ul>
    <div class="nolist nolist2" style="display:none">
      <img src="../image/createRoom/tu_wufangjian.png" alt="">
      <p>暂无房间，请创建新房间</p>
      <p class="createBtn"  id="createGames"  onclick="createRoom2()">创建</p>
    </div>

  </section>

</body>
<script src="../script/api.js" charset="utf-8"></script>
<script src="../script/jquery-3.2.1.js" charset="utf-8"></script>
<script src="../script/public.js" charset="utf-8"></script>
<script src="../script/XBack.js" charset="utf-8"></script>
<script type="text/javascript" src="../script/jquery-touch.js" charset="utf-8"></script>
<script type="text/javascript" src="../script/clipboard.min.js" charset="utf-8"></script>
<script type="text/javascript">
    apiready = function(){
//--------数据请求---------------
      $("#activity").hide();
      var userInfo=$api.getStorage('userInfo');//本地存储的登录用户信息

      //判断用户是否登录
      if(userInfo==null||userInfo==undefined||userInfo=="")
      {
        return;
      }
      //加入房间监听  index页的进入按钮发送
      api.addEventListener({
          name: 'addroom'
        }, function(ret, err){
          if( ret ){
               window.location.reload();
          }else{
               console.log( JSON.stringify( err ) );
          }
      });
      //游戏房间列表（监听事件） 红包游戏房间页发送监听（进入红包游戏房间，重新渲染房间列表）
      api.addEventListener({
         name: 'addRoomEvt'
        }, function(ret, err) {
          createGameRoomList(userInfo.lophone);//游戏房间
          getRoomList();//彩票房间
      });

      createGameRoomList(userInfo.lophone);
      getRoomList();
      //创建游戏房间监听 createRoom1页发送监听
      api.addEventListener({
          name: 'createLotteryTicket'
        }, function(ret, err){
           // alert(222)
          if( ret ){
            createGameRoomList(userInfo.lophone);//游戏房间
            getRoomList();//彩票房间
          }
      });
      // 监听重新登录 login页发送的监听
      api.addEventListener({
          name: 'doLogin'
      }, function(ret, err) {
          if (ret) {
              var type = 1;
              userInfo = ret.value.userInfo;
              type = userInfo.loredEnvelope;
              window.location.reload();
          }
      });
      //  创建彩票房间监听 createSuccess页面发送的监听
      api.addEventListener({
          name: 'createSuccessListen'
        }, function(ret, err){
          if( ret ){
            createGameRoomList(userInfo.lophone);//游戏房间
            getRoomList();//彩票房间
          }
      });
      //退出房间监听 彩票房间和红包房间内发送的监听
      api.addEventListener({
          name: 'quitRoom'
        }, function(ret, err){
          console.log(JSON.stringify(ret));
          console.log(JSON.stringify(err));
          if( ret ){
            window.location.reload();
            // createGameRoomList(userInfo.lophone);//游戏房间
            // getRoomList();//彩票房间
          }
      });
      //获取彩票房间列表
      function getRoomList(){
        $('.tab_ulLott').html("");
        //--------数据请求---------------
        api.ajax({
            url:DATABASE_URL+'lottery-web/lottery/getLRoomByUserId?userId='+userInfo.lophone,
            method: 'get'

        },function(ret, err){
          // console.log(JSON.stringify(ret));
            if (ret) {
              if(ret.status==2)//没有房间时，显示无房间页面
              {
                $('.nolist1').show();
              }else if(ret.status==1){
                $('.nolist1').hide();

                $('.tab_ulLott').html('');
                $(".tab_ulLott").show();
                if(ret.list){
                  //typeca标注了该房间是用户创建的还是用户加入的
                  //groupId为房间创建时在融云上创建的群组id
                  //lotteryId标注了彩票类型（1、重庆时时彩，2、北京赛车）
                  //roomid为房间id
                  //groupName为房间名称
                  for(var i=0;i<ret.list.length;i++){
                    if(ret.list[i].lotteryId==1)
                    {
                      var str ='<li class="roomDetail roomlottery" groupId='+ret.list[i].groupId+' lotteryId='+ret.list[i].lotteryId+' id='+ret.list[i].roomid+' typeca='+ret.list[i].typeca+'>'+
                               '<div class="picture"><img src="../image/discover/activity_02.png" alt=""></div>'+
                               '<div class="headline">'+
                                  '<div class="headline_title">'+ret.list[i].groupName+'</div>'+
                                  '<span class="headline_time">类型:重庆时时彩</span>'+
                               '</div>'+
                              '</li>'
                      $('.tab_ulLott').append(str);
                    }
                    else{
                      var str ='<li class="roomDetail roomlottery" groupId='+ret.list[i].groupId+' lotteryId='+ret.list[i].lotteryId+' id='+ret.list[i].roomid+' typeca='+ret.list[i].typeca+'>'+
                               '<div class="picture"><img src="../image/discover/activity_02.png" alt=""></div>'+
                               '<div class="headline">'+
                                  '<div class="headline_title">'+ret.list[i].groupName+'</div>'+
                                  '<span class="headline_time">类型:北京赛车</span>'+
                               '</div>'+
                              '</li>'
                      $('.tab_ulLott').append(str);
                    }
                  }
                }
              }
            }
            else {
                // toast("网络错误");
            }
        });
      }



//-----------------------------------------
      //点击切换事件
      $("#tab_nav").on("click",'li',function(){
        $(this).addClass('tab_nav_active');
        $(this).siblings().removeClass('tab_nav_active');
        if($(this).index() == 0){
          $("#tab_content").show();
          $("#activity").hide();
        }else {
          $("#activity").show();
          $("#tab_content").hide();
        }
      })


      //点击跳转到游戏房间详情界面
      $('.tab_ulGame').on('click','li',function(){
              var roomId = $(this).attr('room');
              var createType = $(this).attr('createType');
            console.log(roomId);

            api.ajax({
               url:GAMEDATABASE_URL+'lottery-web/NNgame/enterRoom?id='+roomId,
               method:'get'
              },function(ret,err){
                 if(ret){
                      if(ret.code == 0){
                        toast("该房间不存在")
                      }else{
                           if(ret.gameroom.gametypecode == 2){
                              api.openWin({
                                  name: 'tab_ulGames',
                                  url: './room/chat_addwin.html',
                                  pageParam: {
                                      groupId:ret.gameroom.id,
                                      name:ret.gameroom.roomName,
                                      NNmultiple: ret.gameroom.gameMultiple,
                                      type:ret.gameroom.gameway,
                                      pass:ret.gameroom.password,
                                      createType:createType,
                                      enterType:2,
                                      numbercode:ret.gameroom.numbercode
                                  }
                              });
                            }
                            else if(ret.gameroom.gametypecode == 3){
                              api.openWin({
                                  name: 'tab_ulGames',
                                  url: './room/chat_winLei.html',
                                  pageParam: {
                                       groupId:ret.gameroom.id,
                                      name:ret.gameroom.roomName,
                                      NNmultiple: ret.gameroom.gameMultiple,
                                      type:ret.gameroom.gameway,
                                      pass:ret.gameroom.password,
                                      createType:createType,
                                      enterType:2,
                                      numbercode:ret.gameroom.numbercode
                                  }
                              });
                            }
                            else{
                              api.openWin({
                                  name: 'tab_ulGame',
                                  url: './room/chat_window.html',
                                  pageParam: {
                                       groupId:ret.gameroom.id,
                                      name:ret.gameroom.roomName,
                                      NNmultiple: ret.gameroom.gameMultiple,
                                      type:ret.gameroom.gameway,
                                      pass:ret.gameroom.password,
                                      createType:createType,
                                      enterType:2,
                                      numbercode:ret.gameroom.numbercode
                                  }
                              });
                            }
                      }
                 }


              })
      });
      var limits=0;//存储用户权限
      // function getLimit(roomId,lophone){
      //   api.ajax({
      //       url: DATABASE_URL+'lottery-web/lottery/getRoomUserQX',
      //       method: 'post',
      //       data:{
      //         values:{
      //           cpfj_id:roomId,
      //           userId:lophone
      //         }
      //       }
      //   },function(ret, err){
      //     console.log( JSON.stringify( ret ) );
      //       if (ret) {
      //         if(ret.status==1){
      //           limits=ret.jurisdiction;
      //         }
      //       } else {
      //           console.log( JSON.stringify( err ) );
      //       }
      //   });
      //
      // }
      //点击跳转到彩票房间详情界面
      $('.tab_ulLott').on('click','li',function(){
          // getLimit($(this).attr("id"),userInfo.lophone);
          var index=$(this).index();
          api.ajax({
              url: DATABASE_URL+'lottery-web/lottery/getRoomUserQX',//请求用户在该房间的权限
              method: 'post',
              data:{
                values:{
                  cpfj_id:$(this).attr("id"),//房间id
                  userId:userInfo.lophone//用户电话
                }
              }
          },function(ret, err){
            console.log( JSON.stringify( ret ) );
              if (ret) {
                if(ret.status==1){
                  limits=ret.jurisdiction;//用户权限
                  console.log(limits);
                  RoomName=$('.tab_ulLott li').eq(index).children().children('.headline_title').html();
                  if($('.tab_ulLott li').eq(index).attr("lotteryId")==1){
                    api.openWin({
                        name: 'chatBox',
                        url: './room/chat_lottery.html',//重庆时时彩房间
                        pageParam: {
                            groupId:$('.tab_ulLott li').eq(index).attr("groupId"),//群组id
                            lotteryId:$('.tab_ulLott li').eq(index).attr("lotteryId"),//彩票id
                            id:$('.tab_ulLott li').eq(index).attr("id"),//房间id
                            name:RoomName,//房间名称
                            typeca:$('.tab_ulLott li').eq(index).attr("typeca"),//创建或加入
                            limits:limits//用户权限
                        }
                    });
                  }
                  else{
                    console.log($('.tab_ulLott li').eq(index).attr("typeca"));
                    api.openWin({
                        name: 'chatBoxB',
                        url: './room/chat_lottB.html',//北京赛车房间
                        pageParam: {
                            groupId:$('.tab_ulLott li').eq(index).attr("groupId"),
                            lotteryId:$('.tab_ulLott li').eq(index).attr("lotteryId"),
                            id:$('.tab_ulLott li').eq(index).attr("id"),
                            name:RoomName,
                            typeca:$('.tab_ulLott li').eq(index).attr("typeca"),
                            limits:limits
                        }
                    });
                  }
                }
              } else {
                  console.log( JSON.stringify( err ) );
              }
          });

      });

    };
    //创建彩票房间页面跳转
    function createRoom(){
      api.openWin({
          name: 'CreateRoomhomePage',
          url: '../html/room/CreateRoomhomePage.html',
          pageParam: {
              name: 'test'
          }
      });
    }
    //创建游戏房间页面跳转
    function createRoom2(){
      api.openWin({
          name: 'createRoom',
          url: '../html/room/createRoom1.html',
          pageParam: {
              name: 'test'
          }
      });
    }

    // 删除房间列表---------------------------------------------------------------
        var type=0;
        $("#activity").on('longTap','.roomgame',function(){
            var top = $(this).offset().top+$(this).height()/2;
            var left = $(this).offset().left+$(this).width()/2;
            var win = $(window).height()-top+$(this).height();
              var groupType = $(this).attr('createType');
              var roomId = $(this).attr('room');
              var groupId = $(this).attr('groupId');
              if(groupType == 1){
                      var html='<ul class = "border" >\
                      <li name = "'+groupType+'" room = "'+roomId+'" groupId = "'+groupId+'">解散</li>\
                      <li>取消</li>\
                    </ul>';
                  }else{
                     var html='<ul>\
                      <li name = "'+ groupType+'" room = "'+roomId+'" groupId = "'+groupId+'">退出</li>\
                      <li>取消</li>\
                    </ul>';
                  }
            $(this).addClass('clip');
            $('.appends').fadeIn();
            $('.appends').css('top',top+'px');
            $('.appends').css('left',left+'px');
            $('.appends').html(html);
             type=1;
          });

          //选择文本框的操作-----------------------------------------
          $('.appends').on('click','li',function(e){
            type = 0;
            var userInfo=$api.getStorage('userInfo');
            if($(this).attr('name') == 1){
                  // alert(1);
                  api.ajax({
                      url:GAMEDATABASE_URL+'lottery-web/NNgame/dismiss?userId='+userInfo.lophone+'&groupId='+$(this).attr('groupId')+'&roomid='+$(this).attr('room'),
                      method:'get'
                  },function(ret,err){
                     console.log(JSON.stringify(ret));
                      if(ret.status == 1){
                        // window.location.reload();
                        // window.location.reload();
                       createGameRoomList(userInfo.lophone)
                    }
                  })
            }else{
               // alert(2);

              api.ajax({
                      url:GAMEDATABASE_URL+'lottery-web/NNgame/quitRoom?userId='+userInfo.lophone+'&groupId='+$(this).attr('groupId')+'&roomid='+$(this).attr('room'),
                      method:'get'
                  },function(ret,err){
                    console.log(JSON.stringify(ret));
                    if(ret.status == 1){
                      createGameRoomList(userInfo.lophone)
                    }
                  })
            }

            e.stopPropagation();
            $('.appends').fadeOut();
            $('.clip').removeClass('clip');
          });
          // 选择文本框的操作-----------------------------------------

         //下拉框消失-------------------------------------------------
          $('#activity').on('touchstart',function(){
              if(type==1){
                $('.clip').removeClass('clip');
                $('.appends').hide();
                type = 0;
              }
          });
          //下拉框消失-------------------------------------------------

    // 删除房间列表---------------------------------------------------------------


    //请求游戏列表
    function createGameRoomList(_id){
      api.ajax({
          url: GAMEDATABASE_URL+'lottery-web/NNgame/findAllRoom?uid='+_id,
          method: 'get'
        },function(ret, err){
            console.log(JSON.stringify(ret));
            if(ret){            
              if(ret.status == 0){
                  $('.nolist2').show();
              }else if(ret.status == 1){
                    var roomName = ['空','牛牛','接龙','扫雷']
                $(".tab_ulGame").show();
                $(".tab_ulGame").html('');
                  var list=ret.list;
                  // console.log(typeof list)
                  // console.log(list)
                  if(list){
                    $('.nolist2').hide();
                    for(var i=0;i<list.length;i++){
                       var str = '<li class="roomDetail roomgame" groupId = "'+list[i].groupId+'" createType = "'+list[i].typeca+'" pass='+list[i].id+' type='+roomName[list[i].lotteryId]+' room='+list[i].roomid+' id='+list[i].groupName+'><div class="picture"><img src="../image/discover/activity_02.png" alt=""></div><div class="headline"><div class="headline_title">房间:'+list[i].groupName+'</div><span class="headline_time">类型:'+roomName[Number(list[i].lotteryId)]+'</span></div></li>';
                       $(".tab_ulGame").append(str);
                    }
                  }
              }else {

              }
            }


      });
      //下拉刷新
      //下拉刷新模块
      api.setCustomRefreshHeaderInfo({
          bgColor: '#C0C0C0'
        }, function() {
          //下拉刷新被触发，自动进入加载状态，使用 api.refreshHeaderLoadDone() 手动结束加载中状态
          //下拉刷新被触发，使用 api.refreshHeaderLoadDone() 结束加载中状态
          window.location.reload();
      });

      $('dom').on('touchstart',function(){//dom页面触发滑动事件时执行下拉刷新
        // api.refreshHeaderLoadDone();
        api.refreshHeaderLoading();
      })
        api.refreshHeaderLoadDone();


      //==============监听手机返回按钮事件============
      // XBack.listen(function(){
      //   console.log('1111111111111111');
      //   alert('点击了返回按钮');
      // });
      // //app退出事件
      // function exitApp(){
      //   navigator.app.exitApp();
      // }
    }

</script>
</html>
