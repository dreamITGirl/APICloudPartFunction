<!DOCTYPE html>
  <html>
  <head>
      <meta charset="utf-8">
      <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
      <title>消息房间</title>
      <link rel="stylesheet" type="text/css"     href="../../css/chat.css">
      <link rel="stylesheet" type="text/css"     href="../../css/api.css"/>
      <link rel="stylesheet" type="text/css"     href="../../css/style.css">
      <link rel="stylesheet" type="text/css"     href="../../css/chat_win.css">

      <style>
        .appends,.appends1{
          width:25%;
          position:fixed;background:#fff;z-index:666;
          border:0.1rem solid #D2D2D2;
          display: none
        }
        .appends ul li{
          height: 3.6rem;
          line-height: 3.6rem;
          font-size: 1.4rem;
          padding: 0 10%;
          border-bottom: 0.1rem solid #fafafa;
        }
         .appends1 ul li{
          height: 3.6rem;
          line-height: 3.6rem;
          font-size: 1.4rem;
          padding: 0 10%;
          border-bottom: 0.1rem solid #fafafa;
        }
        /*附加面板*/
      .appendAction{
        display: flex;
        padding-top: 3.2rem;
        padding-bottom: 3.2rem;
      }
      .appendAction_content img{
        width: 5.5rem;
        height: 5.5rem;
        margin-left:28%;
      }
      .appendAction_content p{
        text-align: center;
        font-size: 1.4rem;
        color: #8a8a8a;
        margin-top: 1rem;
      }
      .appendAction_content{
        flex: 1;
        //background: red;
      }

      .myRedImg{
        padding: 0.5rem!important;
        width: 60%;
      }
      .myRedImg .redImg{
        background: url('../../image/redImg/beijing2.png') no-repeat;background-size:100% 100%;width: 100%;height: 8rem;position: relative;
      }
      .myRedImg .redImg img{
        height: 50%;top: 10%;left: 5%;position: absolute;
      }
      .myRedImg .redImg p{
        position: absolute;font-size: 1.3rem;
      }

      /*开红包遮罩层----------------------------------------------*/
    .addAddressTo{
        width: 100%;
        height: 100%;
        position: fixed;
        bottom: 0rem;
        left: 0rem;
        color: #DDC69A;
        font-size: 1.6rem;
        text-align: center;
        z-index: 1000000;
      }
      .addAddressTo .shade{
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5)
      }
      .addAddressTo .shadeAddress{
        width: 84%;
        height: 70%;
        margin-left: 8%;
        position: absolute;
        line-height: 2.5rem;
        background: url('../../image/redImg/hongbao-beijing.png') no-repeat;
        background-size: 100% 100%;
        top: 11rem;
      }

      /*红包关闭图片*/
      .red_close{
        width: 1.5rem;height: 1.5rem;
        top:1.5rem;
        left: 4%;position: absolute;
      }
      .red_person{
        width: 7.6rem;margin: 2.5rem auto;
        margin-bottom: 0;
      }
      .red_person img{
        width: 7.6rem;border-radius: 50%;
      }
      .red_more{
        font-size: 1.9rem;margin-top: 1rem;
      }
      .red_open{
        left:10%;position: absolute;width: 80%;
        height:10rem;top: 48.5%;
      }
      .red_open img{
        width: 10rem;border-radius: 50%;
      }
      .red_name{
        font-weight: 600;
      }
      .look_more{
        width:100%;text-align:center;
        position: absolute;
        bottom: 5rem;font-size: 1.4rem;
      }

      .msg{
        width: 70%!important;
        padding: 0.5rem!important;
        margin-left: 15%!important;text-align: center;background: #d0d0d0!important;color: #fff;
      }

      .text_blue{
        color: #49CFFF;
      }
      .text_red{
        color: #D81D07;
      }
      .text_red1{
        color:green;
      }
      #text_red{
        color: #D81D07;
      }
      .text_ff{
        color: #666666;
      }
      .text_fff{
        color: #fff;
      }
      .text_green{
        color: #0F9E3F;
      }
      .mask {
         width:100%;
         height:100%;
         position:relative;
         background-color:rgba(102, 102, 102, .5);
         z-index:2000000;
         display:none;
      }
      .maskBlack {
         width:100%;
         height:100%;
         background-color:rgba(0, 255, 255,0);
         z-index:1000;
         display:none;
         position:fixed;
      }

    .checked{
       background-color:purple;
    }

    .maskLayer{
      width:100%;
      height:100%;
      background-color:rgba(225,225,225,.5);
      position:absolute;
      top:0;
      left:0;
      border-radius:0.5rem;
    }
    #diaplayNone {
     display:none;
    }
    .msgRed{
      color:red;
    }
    .purple{
      color:purple;
    }
    /*.msg{
       color:pink;
    }*/
      </style>
  </head>
  <body>
   <!-- 监听断网状态 -->
    <!-- <div class = "mask"></div> -->
   <!-- 监听断网状态 -->
    <div id = "diaplayNone"></div>
    <div class="appends"></div>
    <div class="appends1"></div>
    <div class = "maskBlack"></div>
    <div id="wrap" class="flex-wrap flex-vertical" >
      <header id="header">
          <ul>
             <li class="border-b mine" >
                  <div class="myMine"></div>
                  <div class="myPiC"><img class="myClose" src="../../icon/mine/go_left.png" alt="" style=" width: 2.5rem;height: 2.5rem;"></div>
                  <div style="position: absolute;width: 100%;text-align: center;" class="roomName">dsdas</div>
                  <div style="position: absolute;width: 15%;right: 21%;line-height: 2.3rem;" class="btnAdd"></div>
                  <div class="myService" id="myMenu">
                    <img src="../../icon/room/caidan.png">
                  </div>
                  <div class="myService myMenu">
                    <img src="../../icon/room/kefu.png">
                  </div>
              </li>
          </ul>
           <!--  菜单管理-->
      <section class="menu hide" id = "hyfhyf">
        <ul>
          <li id="memberInfor">
            <div class="menuIcon"><img src="../../icon/room/cj_chengyuan.png" style="height: 1.4rem"></div>
            <div class="menuText">房间成员</div>
          </li>
          <li id="manageRoom">
            <div class="menuIcon"><img src="../../icon/room/cj_guanli.png" style="height: 1.4rem"></div>
            <div class="menuText" id = "roomGl">房间管理</div>
          </li>
          <li id = "shareOther">
            <div class="menuIcon"><img src="../../icon/room/cj_fenx.png" style="height: 1.4rem"></div>
            <div class="menuText" id = "fenShear">分享</div>
          </li>
          <li id = "copycopy">
            <div class="menuIcon"><img src="../../icon/room/cj_fuzhi.png" style="height: 1.4rem"></div>
            <div class="menuText" id = "copayPass">复制房间链接</div>
          </li>
          <li>
            <div class="menuIcon"><img src="../../icon/room/cj_tuichu.png" style="height: 1.4rem"></div>
            <div class="menuText" id='goBack'>退出房间</div>
          </li>
        </ul>
      </section>
      </header>


      <!--侧边栏 -->
      <section class="menuRight" falg="true">
        <ul id = "sidebar">
          <li class = "setting">
            <img src="../../image/createRoom/cehua_-niu.png" alt="">
            <p>未设置</p>
            <!-- <span style="display:block">9</span> -->
          </li>
          <li name = "111111" type = "1" value = "1" newType = "牛牛：三元五包">
            <img src="../../image/createRoom/cehua_-niu.png" alt="">
            <p>牛牛:3元5包</p>
            <!-- <span style="display:block">9</span> -->
          </li>
          <li name = "111111" type = "2" value ="1" newType = "接龙：三元五包">
            <img src="../../image/createRoom/cehua_long.png" alt="">
            <p>接龙:3元5包</p>
            <!-- <span style="display:block">11</span> -->
          </li>
          <li name = "111111" type = "3" value ="1" newType = "扫雷：三元五包">
            <img src="../../image/createRoom/cehua_lei.png" alt="">
            <p>扫雷:3元5包</p>
            <!-- <span style="display:block">11</span> -->
          </li>
          <li name = "111111" type = "1" value ="2" newType = "牛牛：五元八包">
            <img src="../../image/createRoom/cehua_-niu.png" alt="">
            <p>牛牛:5元8包</p>
            <!-- <span style="display:block">11</span> -->
          </li>
          <li name = "111111" type = "2" value ="2" newType = "接龙：五元八包">
            <img src="../../image/createRoom/cehua_long.png" alt="">
            <p>接龙:5元8包</p>
            <!-- <span style="display:block">11</span> -->
          </li>
          <li name = "111111" type = "3" value ="2" newType = "扫雷：五元八包">
            <img src="../../image/createRoom/cehua_lei.png" alt="">
            <p>扫雷:5元8包</p>
            <!-- <span style="display:block">11</span> -->
          </li>
         <!--  <li>
            <img style="margin-top:1.7rem" src="../../icon/room/add.png" alt="">
          </li> -->
        </ul>
      </section>
      <section class="moveOut" id="move"></section>
<!--  -->
     <div style="width:100%;height:8rem;"></div>
<!-- 聊天页面 -->
      <div id="convo">
         <ul class="chat-thread" id="chatThread">
               <!-- 聊天页面的几个模板 -->
           <!--  <li class="msg">ssssssssssssssss</li>
                 <li class="resultMsg msg" style="text-align: left;"></li>
                 <li class="resultMsg msg" style="text-align: left;">
                    <div>
                      <span class="text_fff">[抢]</span>
                      <span class="text_fff" style="text-align: center;width: 70%;">平地一声雷</span>
                      <span class="text_fff">无雷</span>
                    </div>
                    <div>
                      <span class="text_blue">[发]</span>
                      <span class="text_blue" style="text-align: center;width: 70%;">平地一声雷</span>
                      <span class="text_blue">免死</span>
                    </div>
                    <div>
                      <span class="text_fff">[抢]</span>
                      <span class="text_fff" style="text-align: center;width: 70%;">平地一声雷</span>
                      <span class="text_fff">无雷</span>
                    </div>
                    <div class="text_red">
                      <span>[抢]</span>
                      <span style="text-align: center;width: 70%;">平地一声雷</span>
                      <span>无雷</span>
                    </div>
                    <div>
                      <span>[抢]</span>
                      <span style="text-align: center;width: 70%;">平地一声雷</span>
                      <span>中雷</span>
                    </div>
                 </li>
                 <li class="myInfo myRedImg"><img class="headPhoto myHeadPhoto" src="../../image/tou.png" alt="">
                      <div class="info redImg" name="'+ret[i][0].redId+'">
                         <img src="../../image/redImg/fahongbao.png">
                         <p style="top: 10%;color:#fff;left: 30%;">恭喜发财，大吉大利</p>
                         <p style="top: 40%;color:#fff;left: 30%;">未抢完红包</p>
                         <p style="bottom: 2%;left: 5%;">双试试娱乐</p>
                      </div>
                 </li>
                 <li class="othersInfo myRedImg"><img class="headPhoto otherHeadPhoto" src="../../image/tou.png" alt="">
                     <div class="info redImg" name="'+ret.rid+'">
                         <img src="../../image/redImg/fahongbao.png">
                         <p style="top: 10%;color:#fff;left: 30%;">三元五包+3雷点+1倍率</p>
                         <p style="top: 40%;color:#fff;left: 30%;">游戏红包</p>
                         <p style="bottom: 2%;left: 5%;">扫雷游戏</p>
                     </div>
                 </li>       -->
          <!--   <li class="msg" >
                    <div>
                       <span >[发]</span>
                       <span  style="text-align: center;width: 70%;">'+name+'</span>
                       <span >免死</span>
                    </div>
                    <div>
                       <span>[抢]</span>
                       <span  style="text-align: center;width: 70%;">'+name+'</span>
                       <span>无雷</span>
                    </div>
                    <div>
                       <span >[抢]</span>
                       <span  style="text-align: center;width: 70%;">'+name+'</span>
                       <span >中雷</span>
                   </div>
                   <div>
                       <span >[抢]</span>
                       <span  style="text-align: center;width: 70%;">系统平台</span>
                       <span >免死</span>
                   </div>
                 </li> -->
               <!-- 聊天页面的几个模板 -->
       </ul>
       <!-- 输入框输入文本的时候页面自动跳转到这里 -->
        <div id="msg_end"></div>
       <!-- 输入框输入文本的时候页面自动跳转到这里 -->
     </div>

     <!--底部工具栏  -->
     <footer class="footer">
           <div class="chatTool">
                <div class="record"><img src="../../icon/chat/luyin.png" alt=""></div>
                <div class="inputBox" ><textarea class="text" id="inputText" name="name" rows="1" cols="2" ></textarea></div>
                <div class="face"   id="face" flag="ture"><img src="../../icon/chat/face.png" alt=""></div>
                <div class="append" id="append" flag="ture"><img src="../../icon/chat/append.png" alt=""></div>
                <div class="state"><span class="send" id="send" style="display:none">发送</span><span class="bet sendYes" id='sendRed'>红包</span></div>
           </div>
           <article class="tool">
                <div class="faceEmoticons" style="display:none">
                      <ul id="Emoticons">
                      </ul>
                </div>
                <div class="appendAction" style="display: none">
                  <div class="appendAction_content" id='cameraAdd'>
                    <img src="../../icon/room/icon_paizhao.png" alt="">
                    <p>拍照</p>
                  </div>
                  <div class="appendAction_content" id="imgAddAll">
                    <img src="../../icon/room/icon_zhaopian.png" alt="">
                    <p>图片</p>
                  </div>
                  <div class="appendAction_content sendYes" id="redSend">
                    <img src="../../icon/room/icon_hongbao.png" alt="">
                    <p>红包</p>
                  </div>
                </div>
           </article>
     </footer>
    </div>

    <!-- 遮罩层 -->
    <div class="addAddressTo" style="display: none">
      <div class="shade"></div>
      <div class="shadeAddress">
        <img class="red_close" src="../../image/redImg/guanbi.png">

        <div class="red_person">
          <img src="../../image/tou.png">
        </div>

        <div class="red_name">Sudsjks</div>
        <div class="red_send">给你发了一个红包，金额随机</div>
        <div class="red_more">恭喜发财，大吉大利！</div>

        <div class="red_open">
          <img id="imgTest" src="../../image/redImg/kai.png">
        </div>

        <div class="look_more">看看大家的手气 ></div>
      </div>
    </div>

  </body>
  <script type="text/javascript" src="../../script/api.js"></script>
  <script type="text/javascript" src="../../script/jquery-3.2.1.js"></script>
  <script type="text/javascript" src="../../script/jquery-touch.js"></script>
  <script type="text/javascript" src="../../script/keyBoard.js"></script>
  <script type="text/javascript" src="../../script/chatBox.js"></script>
  <script type="text/javascript" src="../../script/clipboard.min.js"></script>
  <script type="text/javascript" src="../../script/public.js"></script>
  <!-- <script type="text/javascript" src="../../script/conversation.js"></script> -->
  <script type="text/javascript" src="../../script/chat.js"></script>
  <script type="text/javascript">
      apiready = function(){
           $(".myPiC").on("click",function(){
              if(pass == '0'){
                  // var url = GAMEDATABASE_URL+'lottery-web/NNgame/quitRoom?userId='+userInfo.lophone+'&groupId='+groupId+'&roomid='+groupId; 
                  var url = GAMEDATABASE_URL+'lottery-web/NNgame/quitHallroom?userId='+userInfo.lophone+'&groupId='+groupId+'&roomid='+groupId;
                  var msg = '您确定要退出房间吗？';
                  confirmRoom(msg,url)
               }else{
                   api.closeWin({})
               }
           });
          //用户登录信息
          var userInfo = $api.getStorage('userInfo');
          var userIdMsg = userInfo.id.substring(0,22);
          console.log(userIdMsg);
          console.log(JSON.stringify(userInfo));
          getNewTime(userIdMsg);
          // return;
          var game = api.pageParam;
          console.log(JSON.stringify(game));
          var gameRedType = game.type;
          var groupId = game.groupId;
          console.log(groupId);//房间ID
          // alert(groupId)
          var bankerId = '';
          var red_code = 1;
          var pass = api.pageParam.pass;

          // 从房间里通过侧边栏进入的标志special = 1；
          var special = api.pageParam.special;
          // 从房间里通过侧边栏进入是点击的哪一个；
          var slideIndex = api.pageParam.slideIndex;

          // 大厅进来的游戏类型newName == 1；牛牛；2；接龙；3扫雷；
          var newName = api.pageParam.newName;
          // 大厅进来的几元几包newType == 1;三元五包；2五元八包；
          var newType = api.pageParam.type;
          // 大厅进房间确定是enterType 1 列表进房间 enterType 2；
          var enterType = api.pageParam.enterType;
          // 大厅进来的房间得到对应的 游戏编号numbercode；
          var numbercode = api.pageParam.numbercode;
          console.log(numbercode);
           // alert(numbercode)
          // 全局存放没有过期的红包
          var redListArr = [];

          // 得到抢过红包的记录-----------------------------
          var RedNumStr = "";
          var getRedNum = [];
          getRedNum = $api.getStorage('clickRedNum');
          console.log(typeof getRedNum);
          console.log(getRedNum);
          console.log(JSON.stringify(getRedNum));
          if(getRedNum){
            RedNumStr = getRedNum.join("");
          }
          console.log(RedNumStr);
          // 得到抢过红包的记录-----------------------------

          // 得到侧边栏基本信息-----------------------------
           var slideMsg = $api.getStorage('slideMessage');
          // 得到侧边栏基本信息-----------------------------

      // 测试登录---------------------------
          // var userRedMsg = $api.getStorage(userIdMsg);
          // console.log(JSON.stringify($api.getStorage(userIdMsg)));
          // console.log(typeof userRedMsg);
          // console.log(userRedMsg[0]);
          // alert(JSON.stringify(userRedMsg))
          // userRedMsg[0] = {};
          // console.log(userRedMsg[0]['0300050008'])
          // alert(userRedMsg);
          // userRedMsg[0] = {};
          // // userRedMsg[1] = {};
          // // userRedMsg[2] = {};
          // var hyfzzz = userRedMsg[0]['0300050008'];
          // if(hyfzzz){
          //   hyfzzz = hyfzzz+1;
          //   userRedMsg[0]['0300050008'] = hyfzzz;
          // }else{
          //   userRedMsg[0]['0300050008'] = 1;
          // }
          // console.log(userRedMsg[0]['0300050008']);
          // console.log(hyfzzz);
          // console.log(userRedMsg);
          // $api.setStorage(userIdMsg,userRedMsg);

          // var userRedMsg = $api.getStorage(userIdMsg);
          // console.log(userRedMsg);
          // var hyfzzz = userRedMsg[1]['030005000111'];
          // if(hyfzzz){
          //     hyfzzz = hyfzzz+1;
          //     userRedMsg[1]['030005000111']= hyfzzz;
          // }else{
          //     userRedMsg[1]['030005000111'] = 1;
          // }
          // console.log(hyfzzz);
          // console.log(userRedMsg);
          // $api.setStorage(userIdMsg,userRedMsg);
          // var userRedMsg = $api.getStorage(userIdMsg);
          // console.log(JSON.stringify(userRedMsg));
          // return;

      // 测试登录---------------------------



         







          // 判断是从哪里进来的-------------------------------
           // var enterType = api.pageParam.enterType;
           // if(enterType == 1){
           //    // 大厅进入的房间

           // }else if(enterType == 2){
           //    // frame1列表中进入的房间

           // }else{
           //    // 其他地方进入的房间

           // }
           // return;
          // 判断是从哪里进来的-------------------------------




          // for(var i = 0;i<newArrLen;i++){
          //    hyf[i].groupId = true;
          // };
          // $api.setStorage(slideMessage,hyf);
          // var zzzz = $api.getStorage(slideMessage);
          // console.log(JSON.stringify(zzzz))

          // hyf[0].name = "asdfadsfagdasdgf";
          // $api.setStorage(slideMessage,hyf);
          // var hhh = $api.getStorage(slideMessage);
          // console.log(JSON.stringify(hhh))

          // return;

          // alert(newName);
          // alert(newType);

         // 从大厅进入的房间-------------------------------------------
         if(enterType == 1){
            $('#sidebar>li').each(function(index,val){
                if($(this).attr('type') == newName){
                   if($(this).attr('value') == newType){
                        console.log(index);
                        console.log(val)
                        slideMsg[index].groupId = groupId;
                        slideMsg[index].gametypecode = numbercode
                        $api.setStorage('slideMessage',slideMsg);
                        var hyf = $api.getStorage('slideMessage');
                        console.log(hyf);
                        console.log(JSON.stringify(hyf))
                       $(this).addClass('checked')
                   }
                }
            })
         }
         // 从大厅进入的房间-------------------------------------------

         $('#sidebar>li:eq('+slideIndex+')').addClass('checked');
          console.log(JSON.stringify(userInfo));
          console.log(userInfo.id);
          console.log(JSON.stringify(game));

          // 复制房间--------------------------------------
            $('#copayPass').on('click',function(){
               if(pass == '0'){
                 alert('大厅房间不可以分享和复制');
                 return;
               }
               var clipBoard = api.require('clipBoard');
                  clipBoard.set({
                    value: pass
                  }, function(ret, err) {
                    if (ret) {
                      toast('复制成功');
                    }
                  });
            })
          // 复制房间--------------------------------------

          //点击别处 菜单隐藏------------------------------------
            $('header').siblings().on('touchstart',function(){
              $('.menu').addClass('hide');
            })
          //点击别处 菜单隐藏------------------------------------

          // 侧边栏点击长按---------------------------------------------------------

              $('#sidebar').on('longTap','li',function(){
                      var top = $(this).offset().top+$(this).height()/2;
                      var left = $(this).offset().left-100;
                      var win = $(window).height()-top+$(this).height();

                      // $(this).addClass('clip');
                      $('.appends').fadeIn();
                      if(win>172){
                        $('.appends').css('top',top+'px');
                      }else{
                        $('.appends').css('top','auto');
                        $('.appends').css('bottom',(win-100)+'px');
                      }
                      $('.appends').css('left',left+'px');
                      if($(this).hasClass('checked')){
                        var html='<ul>\
                                  <li>设置</li>\
                                  <li>退出</li>\
                                </ul>';
                      $('appends').css('height','7.2rem')
                      }else{
                        var html='<ul>\
                                  <li>设置</li>\
                                </ul>';
                      $('appends').css('height','3.6rem')
                      }
                      $('.appends').html(html);
              });
              $('#sidebar').on('click','li',function(){
                      var slideIndex = $(this).index();
                      var slideMsg = $api.getStorage('slideMessage');
                      // 有ID就直接进入没有ID就随机进入
                      if(slideMsg[slideIndex].groupId){
                           // 进入设置的房间 192.168.1.181:8080/lottery-web/NNgame/accessInstallroom?userId=&numbercode=&roomid=  userId为用户手机号，numbercode为游戏编号，roomid为房间id
                           console.log(userInfo.lophone);
                           console.log(slideMsg[slideIndex].gametypecode);
                           console.log(slideMsg[slideIndex].groupId);
                           // return;
                           api.ajax({
                             url:GAMEDATABASE_URL+'lottery-web/NNgame/accessInstallroom?userId='+userInfo.lophone+'&numbercode='+slideMsg[slideIndex].gametypecode+'&roomid='+slideMsg[slideIndex].groupId,
                             method:'get'
                           },function(ret,err){
                              console.log(JSON.stringify(ret));
                              console.log(JSON.stringify(err));
                           });
                      }else{
                           console.log(userInfo.lophone);
                           console.log(slideMsg[slideIndex].gametypecode);
                           console.log(slideMsg[slideIndex].groupId);
                           // return;
                           api.ajax({
                             url:GAMEDATABASE_URL+'lottery-web/NNgame/accessInstallroom?userId='+userInfo.lophone+'&numbercode='+slideMsg[slideIndex].gametypecode+'&roomid=',
                             method:'get'
                           },function(ret,err){
                              console.log(JSON.stringify(ret));
                              console.log(JSON.stringify(err));
                           })
                      }

                     // 点击设置按钮的时候--------------------------
                     if($(this).hasClass('setting')){
                         api.openWin({
                            name: 'selectRooms',
                            url:"selectRooms.html"
                         });
                         return;
                     }
                      // 点击设置按钮的时候--------------------------
                      var gid = $(this).attr('name'),
                          pass = $(this).attr('pass'),
                          name = $(this).attr('type'),
                          type = $(this).attr('value');
                      // 加入房间
                      var openname = '';
                      var roomName = "";
                      var openurl = '';
                      var num = Math.random()*1009;
                      // 牛牛---------------
                      if(name == 1){
                          openname = 'NNWindow';
                          openurl = 'chat_window.html?num='+num;
                          if(type == 1){
                              roomName = "牛牛：三元五包";
                          }else{
                              roomName = "牛牛：五元八包";
                          }
                      // 接龙-------------------
                      }else if(name == 2){
                          openname = 'JLWindow';
                          openurl = 'chat_addwin.html?num='+num;
                          if(type == 1){
                              roomName = "接龙：三元五包";
                          }else{
                              roomName = "接龙：五元八包";
                          }
                      // 扫雷------------------------
                      }else{
                          openname = 'SLWindow';
                          openurl = 'chat_winLei.html?num='+num;
                          if(type == 1){
                              roomName = "扫雷：三元五包";
                          }else{
                              roomName = "扫雷：五元八包";
                          }
                      }

                     console.log('固定name'+gid+'游戏类型'+name+'几元几包'+type+'打开名字'+openname+'打开地址'+openurl+'游戏类型和几元几包'+roomName);
                      joinRoom(gid,name,type,openname,openurl,roomName,slideIndex);
                     $(this).addClass('checked')
              });
                // 加入房间
            function joinRoom(gid,name,type,openname,openurl,roomName,slideIndex){
                var num = Math.random()*1000;
                console.log(name);
                console.log(type);
                console.log(userInfo.lophone);
                api.ajax({
                    url: GAMEDATABASE_URL+'lottery-web/NNgame/accessRoom?gametypecode='+name+'&gameway='+type+'&userId='+userInfo.lophone+'&num='+num,
                    // url: GAMEDATABASE_URL+'lottery-web/NNgame/accessRoom?gametypecode='+name+'&gameway='+type+'&userId='+userInfo.lophone,
                    // method: 'get'
                }, function(ret, err) {
                     console.log(JSON.stringify(ret));
                    if (ret) {
                        gid = ret.id;
                        name = roomName;
                        type = ret.gameway;
                        openWindow(gid,name,type,openname,openurl,slideIndex);
                    } else {
                        toast('请稍后重试...');
                    }
                });
            }
            // 打开牛牛接龙扫雷游戏房间
            function openWindow(gid,name,type,openname,openurl,slideIndex){
                api.openWin({
                  name: openname,
                  url: openurl,
                  pageParam: {
                      groupId:gid,
                      name:name,
                      NNmultiple: 1,
                      type:type,
                      pass:0,
                      creatType:1,
                      special:1,
                      slideIndex:slideIndex
                  }
                });
            }

          // 侧边栏点击长按---------------------------------------------------------


// 第零步==============================================查看是否有没有抢完的红包
        function judgerRed(gid,code){
            api.ajax({
                url: GAMEDATABASE_URL+'lottery-web/Saolei/incompleteRed?id='+gid,
                method: 'get'
            }, function(ret, err) {
                console.log(JSON.stringify(ret))
                if(ret.code==0){
                   //没有未抢完的红包
                }else{
                    for(var i=0;i<ret.length;i++){
                        var html='<div class="info redImg" name="'+ret[i][0].redId+'" Uiphone = "'+userInfo.lophone+'" Uid = "'+userInfo.id+'">\
                             <img  Uiphone = "'+userInfo.lophone+'" Uid = "'+userInfo.id+'" src="../../image/redImg/fahongbao.png">\
                             <p style="top: 10%;color:#fff;left: 30%;">恭喜发财，大吉大利</p>\
                             <p style="top: 40%;color:#fff;left: 30%;">未抢完红包</p>\
                             <p style="bottom: 2%;left: 5%;">双试试娱乐</p>\
                             </div>';
                        var reHtml = '<li class="othersInfo myRedImg" Uiphone = "'+userInfo.lophone+'" Uid = "'+userInfo.id+'"><img class="headPhoto otherHeadPhoto" src="../../image/tou.png" alt="">'+html+'</li>'
                        sendRedFun(groupId,html,reHtml,'H');
                    }
                }
            });
        }

// 第零步==============================================查看是否有没有抢完的红包
 //初始查出来没有过期的列表------------------------------------------------
                api.ajax({
                   url:GAMEDATABASE_URL+'lottery-web/NNgame/getRoomRed?id='+groupId,
                   method:'get'
                },function(ret,err){
                        console.log(JSON.stringify(ret))
                      redList = ret.list;
                      redListArr = [];
                   if(redList.length>0){
                      // 把未过期的红包红包做成一个集合
                      redListArr = redList;

                      console.log(JSON.stringify(redList));
                   }

                   // 第一步===============================================获取历史聊天信息
                   getHistory();
                   // 第一步===============================================获取历史聊天信息


                })
              //初始查出来没有过期的列表------------------------------------------------

        // 第一步===============================================获取历史聊天信息
         function getHistory(){
             getHistoryMessages("GROUP",groupId,function(ret,err){
                 console.log(JSON.stringify(err));
                 console.log(JSON.stringify(ret));
                      if(ret.status=="error"){
                         // sendRedSystem();
                         window.location.reload();
                         judgerRed(groupId,red_code);
                      }else if(ret.status=="success"){
                         var result = ret.result;
                         if(result == ''){
                         judgerRed(groupId,red_code);
                         }else{
                            // console.log(JSON.stringify(result))
                            for(var i= result.length-1;i>=0;i--){           //  这里是倒序 输出历史消息
                              var  data = result[i];
                              console.log(JSON.stringify(data.content))
                              if(data.content.extra=='S'){
                                var html = '<li class="othersInfo myRedImg"><img class="headPhoto otherHeadPhoto" src="../../image/tou.png" alt="">'+data.content.text+'</li>';
                                $api.append($api.byId("chatThread"),html);
                              }else if(data.senderUserId==userInfo.lophone){
                                    //  判断发送消息的用户手机 和 当前用户的手机 是否相同 如果是则是自己发送的消息  则消息列表 显示在左侧
                                    var flag = data.content.hasOwnProperty("text")  //  判断是否还有文本信息的属性   对应的是  用户发送的图片信息
                                    if(flag){
                                        var  text = data.content.text;
                                        var extra = data.content.extra;
                                         $('#diaplayNone').html(text);
                                        var specialRedId = $('#diaplayNone').find('.info').attr('name');
                                        var Uid = $('#diaplayNone').find('.info').attr('Uid');
                                        var Uiphone = $('#diaplayNone').find('.info').attr('Uiphone');
                                        var html  = '';
                                        if(extra=='H'){
                                            $('#diaplayNone').html(text);
                                            if($.inArray(specialRedId,redListArr) == -1){
                                               $('#diaplayNone').find('.haveFinish').html('红包已经过期');
                                            }
                                            if(RedNumStr.indexOf(specialRedId)>-1){
                                                $('#diaplayNone').find('.info').append('<div class = "maskLayer"></div>');
                                            };
                                            var html = '<li class="othersInfo myRedImg"><img class="headPhoto otherHeadPhoto" Uiphone = "'+Uiphone+'" Uid = "'+Uid+'"  userId = "'+userInfo.id+'" src="../../image/tou.png" alt="">'+ $('#diaplayNone').html()+'</li>';
                                        }else if(extra == 'R'){
                                            if($.inArray(specialRedId,redListArr) == -1){
                                              $('#diaplayNone').find('.haveFinish').html('红包已经过期');
                                            };
                                            if(RedNumStr.indexOf(specialRedId)>-1){
                                              $('#diaplayNone').find('.info').append('<div class = "maskLayer"></div>');
                                            };
                                            if(userInfo.loimg == '' || userInfo.loimg == 'img'){
                                              html  = '<li class="myInfo myRedImg"><img class="headPhoto myHeadPhoto" Uiphone = "'+Uiphone+'" Uid = "'+Uid+'"  userId = "'+userInfo.id+'" src="../../image/tou.png" alt="">'+$('#diaplayNone').html()+'</li>'
                                            }else{
                                              html  = '<li class="myInfo myRedImg"><img class="headPhoto myHeadPhoto" Uiphone = "'+Uiphone+'" Uid = "'+Uid+'"  userId = "'+userInfo.id+'" src="'+baseUrl+userInfo.loimg+'" alt="">'+$('#diaplayNone').html()+'</li>'
                                            }
                                        }else if(extra == 'T'){
                                            if(userInfo.loimg == '' || userInfo.loimg == 'img'){
                                              html = '<li class="myInfo"><img class="headPhoto myHeadPhoto" Uiphone = "'+Uiphone+'" Uid = "'+Uid+'"  userId = "'+userInfo.id+'" userId = "'+userInfo.id+'" src="../../image/tou.png" alt="">'+text+'</li>'
                                            }else{
                                              html = '<li class="myInfo"><img class="headPhoto myHeadPhoto" Uiphone = "'+Uiphone+'" Uid = "'+Uid+'"  userId = "'+userInfo.id+'"  userId = "'+userInfo.id+'" src="'+baseUrl+userInfo.loimg+'" alt="">'+text+'</li>'
                                            }
                                        }else if(extra == 'M'){
                                            html = text;
                                        };
                                        $api.append($api.byId("chatThread"),html);
                                     };
                              }else {
                                   var flag = data.content.hasOwnProperty("text")  //  判断是否还有文本信息的属性
                                   if(flag){
                                      var  text = data.content.text;
                                      var extra = data.content.extra;
                                      $('#diaplayNone').html(text);
                                      var specialRedId = $('#diaplayNone').find('.info').attr('name');
                                      var Uid = $('#diaplayNone').find('.info').attr('Uid');
                                      var Uiphone = $('#diaplayNone').find('.info').attr('Uiphone');
                                      var html = '';
                                      console.log(text);
                                      if(extra=='T'){            // 文字消息
                                           html  = '<li class="othersInfo"><img class="headPhoto otherHeadPhoto" Uiphone = "'+Uiphone+'" Uid = "'+Uid+'"  userId = "'+userInfo.id+'"  src="../../image/tou.png" alt="">'+text+'</li>';
                                      }else if(extra=='R'){          // 红包消息
                                          if($.inArray(specialRedId,redListArr) == -1){
                                            $('#diaplayNone').find('.haveFinish').html('红包已经过期');
                                          };
                                          if(RedNumStr.indexOf(specialRedId)>-1){
                                            $('#diaplayNone').find('.info').append('<div class = "maskLayer"></div>');
                                          };
                                          html = '<li class="othersInfo myRedImg"><img class="headPhoto otherHeadPhoto"  Uiphone = "'+Uiphone+'" Uid = "'+Uid+'"  userId = "'+userInfo.id+'" src="../../image/tou.png" alt="">'+$('#diaplayNone').html()+'</li>';
                                      }else if(extra=='M'){      // 提示消息
                                          html = text;
                                      };
                                      $api.append($api.byId("chatThread"),html);
                                   };
                              };
                            };
                         };
                      };
             });
          };
        // 第一步===============================================获取历史聊天信息

        
//====================聊天========功能===========消息=====================-
        rongFunListener(function(ret,err){
              console.log(JSON.stringify(ret))
              if(ret.result.message.hasOwnProperty("targetId")){            // 判断是否还有当前targetID 属性
                    if(ret.result.message.targetId==groupId){          //  判断接受的 targetID 和当前的房间 id 是否一样
                          if(ret.result.message.hasOwnProperty("content")){      //判端 接受的消息 是否还有 content 的属性
                                $('#diaplayNone').html(ret.result.message.content.text);
                                var specialRedId = $('#diaplayNone').find('.info').attr('name');
                                var Uid = $('#diaplayNone').find('.info').attr('Uid');
                                var Uiphone = $('#diaplayNone').find('.info').attr('Uiphone');
                                var html = '';
                                if(ret.result.message.content.extra=='T'){
                                        html  = '<li class="othersInfo"><img class="headPhoto otherHeadPhoto" Uiphone = "'+Uiphone+'" Uid = "'+Uid+'" src="../../image/tou.png" alt="">'+ret.result.message.content.text+'</li>';
                                }else if(ret.result.message.content.extra=='R'||ret.result.message.content.extra=='S'){
                                        // 红包消息
                                        // 开启定时器，rid为红包id，uid为发红包人的id，roomid为房间id--------------------------------
                                        api.ajax({
                                           url:GAMEDATABASE_URL+'lottery-web/NNgame/timekeeper?rid='+specialRedId+'&uid='+Uid+'&roomid='+groupId,
                                           method:'get'
                                        },function(ret,err){
                                        });
                                        // 开启定时器，rid为红包id，uid为发红包人的id，roomid为房间id--------------------------------
                                        html  = '<li class="othersInfo myRedImg"><img class="headPhoto otherHeadPhoto" Uiphone = "'+Uiphone+'" Uid = "'+Uid+'"  src="../../image/tou.png" alt="">'+ret.result.message.content.text+'</li>';
                                }else if(ret.result.message.content.extra=='M'){
                                        // 提示消息
                                        html = ret.result.message.content.text;
                                };
                                $("#chatThread").append(html);
                                document.getElementById('msg_end').scrollIntoView();
                          };
                    };
              };
        })
//====================聊天========功能===========消息=====================-


// 第三步=============================================================发红包

        //点击发红包------------------------------------------------------
          $('.sendYes').on('click',function(){
              // game.type 1 三元五包 2 5元八包 3 十元八包
              api.openWin({
                  name: 'redEnvelope',
                  url: 'redEnvelopes.html',
                  pageParam: {
                      redType: game.type,
                      multiple:game.NNmultiple,
                      bankerId:bankerId,
                      type:'1',
                      numbercode:numbercode
                  }
              });
          });
        //点击发红包------------------------------------------------------
        // 发送红包---------------------------------------------
        api.addEventListener({
          name: 'sendRedMoneyLei'
        }, function(ret, err) {
          var money = ret.value.money,  // 金额 几元
          num = ret.value.num,         // 数目  几包
          text = ret.value.text,       //雷点   几雷点
          type = ret.value.type;        // 红包类型 红包类型几元几包
          multiple = ret.value.multiple;
          newNumbercode = ret.value.numbercode

           console.log(groupId);
           console.log(multiple);
           // 赔率
           // alert(money);
           // alert(num);
           // alert(type);
           // 发送红包等待后台接口
          sendRedUser(userInfo.id,groupId,text,newNumbercode)
        });

        // 用户发红包.................................
        function sendRedUser(userId,groupId,text,newNumbercode){
           console.log(userId);
           console.log(groupId);
           console.log(text)
          api.ajax({
             url: GAMEDATABASE_URL+'lottery-web/Saolei/redPacket?uid='+userId+'&id='+groupId+'&leiqu='+text,
             method: 'get'
           }, function(ret, err) {
             console.log(JSON.stringify(ret))
            if (ret.code==1) {
                   // redCount();
               var retName = ret.name;
               if(ret.name == "无昵称" || ret.name == ""){
                   retName = "用户"+userId.substring(userId.length-4)
               }
              var html='<div class="info redImg" Uiphone = "'+userInfo.lophone+'" Uid = "'+userInfo.id+'" newName = "'+retName+'" name="'+ret.rid+'">\
                     <img src="../../image/redImg/fahongbao.png">\
                     <p style="top: 10%;color:#fff;left: 30%;">扫雷|雷点:'+text+'</p>\
                     <p style="top: 40%;color:#fff;left: 30%;" class = "haveFinish">游戏红包</p>\
                     <p style="bottom: 2%;left: 5%;">扫雷游戏</p>\
                     </div>'
              if(userInfo.loimg == '' || userInfo.loimg == 'img'){
                var reHtml = '<li class="myInfo myRedImg"><img class="headPhoto myHeadPhoto" Uiphone = "'+userInfo.lophone+'" Uid = "'+userInfo.id+'" src="../../image/tou.png" alt="">'+html+'</li>'
              }else{
                var reHtml = '<li class="myInfo myRedImg"><img class="headPhoto myHeadPhoto" Uiphone = "'+userInfo.lophone+'" Uid = "'+userInfo.id+'" src="'+baseUrl+userInfo.loimg+'" alt="">'+html+'</li>'
              }
              sendRedFun(groupId,html,reHtml,'R',ret.rid,newNumbercode);
            } else {
              api.toast({msg:'网络错误，红包发送失败'});
            }
          });
           // 用户发红包后记录下来发红包的次数
            // function redCount(){
            //     var userRed = $api.getStorage('userRed');
            //        userRed++;
            //        $api.setStorage('userRed',userRed);
            //        var x = $api.getStorage('userRed');
            //        console.log(x)
            // }
        }
// 第三步=============================================================发红包

//  发送文本消息-------------------------------------------------------------
        $("#send").on("click",function(){
          var Message = $("#inputText").val();
          if(Message=="" || Message=="null" || Message==undefined){
             toast("没有输入")
           }else{
                var html = '<div class="info" Uiphone = "'+userInfo.lophone+'"  Uid = "'+userInfo.id+'" >'+transText(Message)+'</div>'
                if(userInfo.loimg == '' || userInfo.loimg == 'img'){
                  var reHtml = '<li class="myInfo"><img class="headPhoto myHeadPhoto" Uiphone = "'+userInfo.lophone+'"  Uid = "'+userInfo.id+'" src="../../image/tou.png" alt="">'+html+'</li>';
                }else{
                  var reHtml = '<li class="myInfo"><img class="headPhoto myHeadPhoto" Uiphone = "'+userInfo.lophone+'" Uid = "'+userInfo.id+'" src="'+baseUrl+userInfo.loimg+'" alt="">'+html+'</li>';
                }
                sendRedFun(groupId,html,reHtml,'T');
           }
        })
//  发送文本消息-------------------------------------------------------------
// 点击头像跳转到详细信息页---------------------------------------------------
        $('#convo').on('click','.headPhoto',function(){
            // alert($(this).attr('Uid'));
            // alert($(this).attr('Uiphone'));
            // return;
            if($(this).attr('Uiphone') == 'undefined'){
               return;
             };
            api.openWin({
                name: 'memberInfor',
                url: 'memberInfor.html',
                pageParam: {
                  name: ($(this).attr('Uiphone')),
                  groupId:groupId,
                  typeStatus:2,
                  userId:$(this).attr('Uid')
                }
            });
         })
// 点击头像跳转到详细信息页---------------------------------------------------
// 第四步==========================================================用户抢红包
        //点击开始抢红包
          var redId = '';
          var newName = '';
          var resNewName = "";
        $('#chatThread').on('click','.redImg',function(){
            redId = $(this).attr('name');
            newName = $(this).attr('newName');
            resNewName = $(this).attr('Uid');
            // alert(resNewName);
            $('.red_name').html(userInfo.louserName)
            $(this).addClass(redId)
              if(resNewName){
                if(!newName || newName == "无昵称"){
                   newName = '用户'+resNewName.substring(resNewName.length-4);
                };
              }
           console.log(newName)
           console.log(groupId);
           console.log(redId);
            // 判断红包是否过期-----------------------------------------
               api.ajax({
                  url:GAMEDATABASE_URL+'lottery-web/NNgame/getRoomRed?id='+groupId,
                  method:'get'
               },function(ret,err){
                  console.log(JSON.stringify(ret))
                  if(ret.list){
                     var redList = ret.list;
                     var redListArr = [];
                     // 把未过期的红包红包做成一个集合
                     for(var i = 0;i<redList.length;i++){
                        redListArr.push(redList[i]);
                     }
                     if($.inArray(redId,redListArr) == -1){
                          toast('来晚一步红包已经过期');
                          $('.red_send').fadeOut(500);
                          $('.red_open').fadeOut(500);
                          $('.addAddressTo').fadeIn(500);
                          $('.look_more').fadeIn(500);
                          $('.red_more').html("红包已经过期");
                          $('#chatThread').find('.'+redId).find('.haveFinish').html('红包已经过期');
                     }else{
                               // 正常判断红包状态-----------------
                                  api.ajax({
                                      url:GAMEDATABASE_URL+'lottery-web/NNgame/panDuan?userId='+userInfo.id+'&rid='+redId,
                                      method: 'get'
                                   },function(ret,err){
                                      console.log(JSON.stringify(ret));
                                         // code 该玩家已抢过此红包
                                        if(ret.code == 2){
                                                api.ajax({
                                                    url:GAMEDATABASE_URL+'lottery-web/Saolei/getRed?roomId='+groupId+'&userId='+userInfo.id+'&rid='+redId,
                                                    method: 'get'
                                                }, function(ret, err) {
                                                console.log(JSON.stringify(ret))
                                                if(ret.code == 3 && ret.status == 1){
                                                  // 红包结束，查询红包结果--------------
                                                  // 传红包ID 和 房间ID;
                                                  console.log(JSON.stringify(ret));
                                                  console.log(JSON.stringify(err));
                                                  ajaxGetRedFun(game.groupId,redId,newName);
                                                }
                                                if (ret.code==3) {
                                                  //查询本用户抢了多少红包———————————————————
                                                  // ajaxGetMoney(userInfo.id,redId,userInfo.louserName,userInfo.lophone,game.groupId);// 打开红包查看拆包金额
                                                  $('.look_more').fadeOut(500);
                                                  $('.red_send').fadeIn(500);
                                                  $('.red_open').fadeIn(500);
                                                  $('.red_more').html("恭喜发财，大吉大利！");
                                                  $('.addAddressTo').fadeIn(500);
                                                  var html= ' <li class="msg">'+userInfo.lophone.substring(0,3)+" **** "+userInfo.lophone.substring(7)+'领取了红包</li>';
                                                  sendRedFun(groupId,html,html,'M');
                                                }else if (ret.code==4) {
                                                  toast('您已经抢过该红包');
                                                  $('.red_send').fadeOut(500);
                                                  $('.red_open').fadeOut(500);
                                                  $('.addAddressTo').fadeIn(500);
                                                  $('.look_more').fadeIn(500);
                                                  $('.red_more').html("您已经抢过该红包");
                                                } else if(ret.code == 1){
                                                   // 金币不足
                                                   toast('您的金币不足以抢红包，请充值');
                                                }else if(ret.code == 2){
                                                  // 红包已经被领取完
                                                  console.log(JSON.stringify(ret));
                                                  $('.red_send').fadeOut(500);
                                                  $('.red_open').fadeOut(500);
                                                  $('.look_more').fadeIn(500);
                                                  $('.red_more').html("手慢了，红包派完了");
                                                  $('.addAddressTo').fadeIn(500);
                                                }
                                            });
                                        }else{
                                                $('.red_send').fadeIn(500);
                                                $('.red_open').fadeIn(500);
                                                $('.look_more').fadeOut(500);
                                                $('.red_more').html("恭喜发财，大吉大利！");
                                                $('.addAddressTo').fadeIn(500);
                                        }
                                    });
                     }
                  }
               })
            // 判断红包是否过期-----------------------------------------


        });
// 第四步==========================================================用户抢红包

//点击'开'按钮，，打开红包-----------------------------------------------------
        $('.red_open').click(function(){
             console.log(game.groupId+"="+userInfo.id+"="+redId+"="+game.NNmultiple);
             $('#imgTest').shake(2, 10, 400);


             // $('#chatThread').find('.haveFinish').html('您已经抢过红包')
             console.log(redId);
             // alert(redId)
             // alert(newName)
            // 存储用户抢红包ID----------------------
              getRedNum.push(redId);
              if(getRedNum.length>1000){
                 getRedNum.splice(0,500);
              }
              console.log(getRedNum)
              $api.setStorage('clickRedNum',getRedNum);
            // 存储用户抢红包ID----------------------
             console.log(groupId);
             console.log(userInfo.id);
             console.log(redId)

                    api.ajax({
                        url:GAMEDATABASE_URL+'lottery-web/Saolei/getRed?roomId='+groupId+'&userId='+userInfo.id+'&rid='+redId,
                        method: 'get'
                    }, function(ret, err) {
                    console.log(JSON.stringify(ret))
                    // $('.red_name').html(userInfo.louserName)
                    if(ret.code == 3 && ret.status == 1){
                      // 红包结束，查询红包结果--------------
                      // 传红包ID 和 房间ID;
                      console.log(JSON.stringify(ret));
                      console.log(JSON.stringify(err));
                      ajaxGetRedFun(game.groupId,redId,newName);
                    }
                    if (ret.code==3) {
                       // getSendRedNum();
                       getAllRedNum(numbercode,userIdMsg);
                      $('#chatThread').find('.'+redId).append('<div class = "maskLayer"></div>');
                      //查询本用户抢了多少红包———————————————————
                      // ajaxGetMoney(userInfo.id,redId,userInfo.louserName,userInfo.lophone,game.groupId);// 打开红包查看拆包金额
                      // $('.red_send').fadeIn(500);
                      // $('.red_open').fadeIn(500);
                      // $('.look_more').fadeOut(500);
                      // $('.red_more').html("恭喜发财，大吉大利！");
                      // $('.addAddressTo').fadeIn(500);
                      var louserName = userInfo.louserName;
                      if(louserName == "无昵称"){
                         louserName = "用户"+userInfo.id.substring(userInfo.id.length-4)
                      }
                       // var html= ' <li class="msg">'+userInfo.lophone.substring(0,3)+" **** "+userInfo.lophone.substring(7)+'领取了红包</li>';
                       var html= ' <li class="msg">'+louserName+'领取了红包</li>';
                      // 发送提示信息
                        sendRedFun(groupId,html,html,'M');
                        if(ret.reward){
                          var rewardNum = Number(ret.reward)/100;
                          // var html= ' <li class="msg msgRed">'+userInfo.lophone.substring(0,3)+" **** "+userInfo.lophone.substring(7)+'中了'+rewardNum+'元</li>';
                          var html= ' <li class="msg msgRed">'+louserName+'中了'+rewardNum+'元</li>';
                          sendRedFun(groupId,html,html,'M');
                         }
                        setTimeout(function(){
                          $('.addAddressTo').fadeOut(500);
                          $('.red_send').fadeOut(500);
                          $('.red_open').fadeOut(500);
                           api.openWin({
                            name: 'redDetail',
                            url: 'redDetails.html',
                            pageParam: {
                              groupId:game.groupId,
                              rid:redId,
                              type:gameRedType
                            }
                          });
                        },700);
                    }else if (ret.code==4) {
                      toast('您已经抢过该红包');
                      $('.red_send').fadeOut(500);
                      $('.red_open').fadeOut(500);
                      $('.look_more').fadeIn(500);
                      $('.red_more').html("您已经抢过该红包");
                      $('.addAddressTo').fadeIn(500);
                    } else if(ret.code == 1){
                       // 金币不足
                       toast('您的金币不足以抢红包，请充值');
                    }else if(ret.code == 2){
                      // 红包已经被领取完
                      console.log(JSON.stringify(ret));
                      $('.red_send').fadeOut(500);
                      $('.red_open').fadeOut(500);
                      $('.look_more').fadeIn(500);
                      $('.red_more').html("手慢了，红包派完了");
                      $('.addAddressTo').fadeIn(500);
                    }
                });
        });
//点击'开'按钮，，打开红包-----------------------------------------------------

// 函数统计接受红包的个数------------------------------------------------------
  function getSendRedNum(){
        // getNewTime();
        var userRedMsg = $api.getStorage(userIdMsg);
        console.log(JSON.stringify($api.getStorage(userIdMsg)));
        console.log(typeof userRedMsg);
        console.log(userRedMsg[0]);
        if(userRedMsg[0]){
        }else{
          userRedMsg[0] = {};
        }

        var hyfzzz = userRedMsg[0][numbercode];
        // alert(hyfzzz);
        if(hyfzzz){
          hyfzzz = hyfzzz+1;
          userRedMsg[0][numbercode] = hyfzzz;
        }else{
          userRedMsg[0][numbercode] = 1;
        }
        // console.log(userRedMsg[0]['0300050008']);
        // console.log(hyfzzz);
        // console.log(userRedMsg);
        $api.setStorage(userIdMsg,userRedMsg);

        var userRedMsg = $api.getStorage(userIdMsg);
        console.log(JSON.stringify(userRedMsg));
  }
// 函数统计接受红包的个数------------------------------------------------------

// 分享-------------------------------------------------------------------
       $('#fenShear').on('click',function(){
             if(pass == '0'){
               alert('大厅房间不可以分享和复制');
               return;
             }
             shareText(pass)
                   function shareText(_text){
                       var sharedModule = api.require('shareAction');
                       sharedModule.share({
                              text:_text,
                              type:'text'
                        });
                   }
       })
// 分享-------------------------------------------------------------------

// 客服-------------------------------------------------------------------
           //打开客服
          var service =$api.dom('#service');
          $api.addEvt(service, 'click', function(){
            openWin('service','../mine/chatService_win.html');
          });
// 客服-------------------------------------------------------------------

//看看大家的手气------------------------------------------------------------
        var lookMore = $api.dom('.look_more');
        $api.addEvt(lookMore,'click',function(){
            $('.addAddressTo').hide();
            console.log(gameRedType)
            api.openWin({
              name: 'redDetail',
              url: 'redDetails.html',
              pageParam: {
                  groupId:game.groupId,
                  rid:redId,
                  type:gameRedType

              }
            });
          });
//看看大家的手气------------------------------------------------------------


//  方法调用==========================================================================
// 发送红包、、、、文字、、、、、、、提示信息-----------------------------------------------------
        function sendRedFun(groupId,html,reHtml,rtype,redId,newNumbercode){
         console.log(redId);
          sendTextMessage('GROUP',groupId,html,rtype,function(ret,err){
                 console.log(JSON.stringify(ret));
                 console.log(reHtml);
                 
                  if(ret.status=="prepare"){
                         var message= ret.result.message;
                         if(message.hasOwnProperty("content")){
                           content =  ret.result.message.content;
                          }
                          // $("#chatThread").append(reHtml)
                  }else if(ret.status=="success"){
                          if(content==""||content=="null"||content==undefined){
                                 toast("发送失败");
                          }else{
                                 $("#inputText").val("")
                                 $("#chatThread").append(reHtml);
                                 document.getElementById('msg_end').scrollIntoView();//发消息页面自动跳转
                                 if(rtype == "R"){
                                      console.log('asdf');
                                       // alert(newNumbercode);
                                       // getNewTime();
                                      getAllRedNum(newNumbercode,userIdMsg);
                                      // 开启定时器，rid为红包id，uid为发红包人的id，roomid为房间id--------------------------------
                                      api.ajax({
                                         url:GAMEDATABASE_URL+'lottery-web/NNgame/timekeeper?rid='+redId+'&uid='+userInfo.id+'&roomid='+groupId,
                                         method:'get'
                                      },function(ret,err){
                                          console.log(JSON.stringify(ret));
                                      });
                                      // 开启定时器，rid为红包id，uid为发红包人的id，roomid为房间id--------------------------------

                                     // 显示红包列表得到系统抢了多少钱--------------------------------------
                                     setTimeout(function(){
                                         api.ajax({
                                             url:GAMEDATABASE_URL+'lottery-web/NNgame/getRedlist?rid='+redId,
                                             method:'get'
                                         },function(ret,err){
                                              console.log(JSON.stringify(ret));
                                              if(ret){
                                                 for(var i = 0;i<ret.length;i++){
                                                     if(ret[i].uid == '系统'){
                                                       var html= ' <li class="msg purple">后台系统领取了红包</li>';
                                                       sendRedFun(groupId,html,html,'M');
                                                     };
                                                 };
                                              };
                                         });
                                     },1000);
                                    // 显示红包列表得到系统抢了多少钱--------------------------------------
                                 }
                          }
                  }else if(ret.status == 'error'){
                          toast("网络错误")
                  };
          })
        }


// 发送红包、、、、文字、、、、、、、提示信息-----------------------------------------------------
// 抢红包结束，判断结果---------------------------------------------------------------------------
        function ajaxGetRedFun(id,rid,newName){
          // 区别于牛牛，扫雷需要向后台提供雷点是什么！！！！！！！！！！！
          api.ajax({
              url:GAMEDATABASE_URL+'lottery-web/Saolei/getRedresult?&rid='+rid,
              method: 'get'
          }, function(ret, err) {
              console.log(JSON.stringify(ret));
              if (ret) {
                var html = '',
                    bankHtml='',
                    name = "";
                for(var i=0;i<ret.length;i++){
                         var uid = ret[i].uid;
                         var name = ret[i].uname;
                         // if(ret[i].uname == ret[i].uid){
                         //     ret[i].uname = "无昵称"
                         // }
                         if(!name){
                            name = "用户"+uid.substring(uid.length-4);
                         }
                         console.log(ret[i].id);
                         console.log(userInfo.id);
                         console.log(ret[i].uid == userInfo.id);
                         if(ret[i].uid == userInfo.id){
                            if(name == '无昵称'){
                                name = "用户"+uid.substring(uid.length-4)
                            }
                            html = html + ' <div>\
                            <span class="text_blue">[发]</span>\
                            <span class="text_blue" style="text-align: center;width: 70%;">'+name+'</span>\
                            <span class="text_blue">免死</span>\
                            </div>'
                        }else if(ret[i].uid == "系统"){
                            html = html + '<div>\
                           <span class="text_blue">[抢]</span>\
                           <span class="text_blue" style="text-align: center;width: 70%;">系统平台</span>\
                           <span class="text_blue">免死</span>\
                         </div>'
                        }else if(ret[i].bunko == '无雷'){
                          if(name == '无昵称'){
                                   name = "用户"+uid.substring(uid.length-4)
                            }
                           html = html + '<div>\
                           <span class="text_red1">[抢]</span>\
                           <span class="text_red1" style="text-align: center;width: 70%;">'+name+'</span>\
                           <span class="text_red1">无雷</span>\
                         </div>'
                        }else if(ret[i].bunko == "中雷"){
                          if(name == '无昵称'){
                                   name = "用户"+uid.substring(uid.length-4)
                            };
                            html = html + '<div>\
                           <span class="text_red">[抢]</span>\
                           <span class="text_red" style="text-align: center;width: 70%;">'+name+'</span>\
                           <span class="text_red">中雷</span>\
                         </div>'
                        }
                  }
                html ='<li class="resultMsg msg" style="text-align: left;">'+html+'</li>';
                // 发送红包抢完后的提示信息
                sendRedFun(groupId,html,html,'M');
                var html1 = '<li class="msg text_red">'+newName+'游戏包已被抢完</li>'
                sendRedFun(groupId,html1,html1,'M');
                // 谁种类了系统就自动就发送红包
                // sendRedUser(url,groupId,text,'三元五包');
              } else {
                  toast('网络错误，请稍后重试');
              }
          });
        }
// 抢红包结束，判断结果---------------------------------------------------------------------------


          $('.roomName').text(game.name);
           api.sendEvent({
               name: 'addRoomEvt',
           });
             //--------------------
             drawFace();// 表情读取
             //---------------------
          // 点击图片--------------------------------
          $('#imgAddAll').on('click',function(){
            var name = 'album';
            imgAdd(name);
          });
           // 点击图片--------------------------------
          //点击相机----------------------------------
          $('#cameraAdd').on('click',function(){
            var name = 'camera';
            imgAdd(name);
          })
          //点击相机----------------------------------
          // 从图库或相机发送图片-----------------------------------
          function imgAdd(album){
            console.log(album)
            api.getPicture({
                sourceType: album,
                encodingType: 'jpg',
                mediaValue: 'pic',
                destinationType: 'url',
                allowEdit: true,
                quality: 50,
                targetWidth: 100,
                targetHeight: 100,
                saveToPhotoAlbum: false
            }, function(ret, err) {
                /*if (ret) {
                    alert(JSON.stringify(ret));
                } else {
                    alert(JSON.stringify(err));
                }*/
            });
          }
          // 从图库或相机发送图片-----------------------------------



          //跳转到房间管理--------------------------------------
          var manageRoom = $api.dom('#manageRoom');
          clickWin(manageRoom,'manageRoom','manageSLroom.html');
          //跳转到房间管理--------------------------------------
          //房间成员
          var memberInfor = $api.dom('#memberInfor');
          $api.addEvt(memberInfor,'click',function(){
              api.openWin({
                name: 'memberRoom',
                url: 'memberRoom.html',
                pageParam: {
                  groupId: game.groupId,
                  typeStatus:2,
                  name:userInfo.lophone,
                  userId:userInfo.id
                }
              });
            });

          function clickWin(dom,name,url){
            $api.addEvt(dom,'click',function(){
              api.openWin({
                name: name,
                url: url,
                pageParam:{
                   message:game,
                   numbercode:numbercode
                }
              });
            });
          }
          var type=0;

          //长按列表------------------------------------------------
          $("#chatThread").on('longTap','.myInfo',function(){
            var top = $(this).offset().top+$(this).height();
            var left = $(this).offset().left+$(this).width()/2;
            var win = $(window).height()-top+$(this).height();
            $(this).addClass('clip');
            $('.appends').fadeIn();
            if(win>200){
              $('.appends').css('top',top+'px');
            }else{
              $('.appends').css('top','auto');
              $('.appends').css('bottom',win+'px');
            }
            $('.appends').css('left',left+'px');
            var html='<ul>\
                      <li>复制</li>\
                      <li>删除</li>\
                      <li>撤回</li>\
                    </ul>';
            $('.appends').html(html);
            type=1;
          });
          //长按列表------------------------------------------------
          //选择文本框的操作-----------------------------------------
          $('.appends').on('click','li',function(e){
            type = 0;
            if($(this).index()==0){
              clicpBord($('.clip').text());
            }else if($(this).index()==1){
              alert('操作删除');
            }else{
              alert('操作撤回');
            }
            e.stopPropagation();
            $('.appends').fadeOut();
            $('.clip').removeClass('clip');
          });
          //选择文本框的操作-----------------------------------------
          //删除复制框消失-------------------------------------------------
          $('#wrap').on('touchstart',function(){
                // $('.menu').addClass('hide');
              if(type==1){
                $('.clip').removeClass('clip');
                $('.appends').hide();
                type = 0;
              }
          });
          //删除复制框消失-------------------------------------------------
          // $('#convo').on('touchstart',function(){
          //        $('.menu').addClass('hide');
          //  });
          // 退出房间--------------------------------------


      // 监听手机返回键退出房间--------------------------------------
       api.addEventListener({
          name: 'keyback'
       }, function(ret, err) {
           if(pass == '0'){
              // var url = GAMEDATABASE_URL+'lottery-web/NNgame/quitRoom?userId='+userInfo.lophone+'&groupId='+groupId+'&roomid='+groupId; 
              var url = GAMEDATABASE_URL+'lottery-web/NNgame/quitHallroom?userId='+userInfo.lophone+'&groupId='+groupId+'&roomid='+groupId;
              var msg = '您确定要退出房间吗？';
              confirmRoom(msg,url)
           }else{
               api.closeWin({})
            }
       });
     // 监听手机返回键退出房间--------------------------------------


           $('#goBack').on('click',function(){
            var url = GAMEDATABASE_URL+'lottery-web/NNgame/quitRoom?userId='+userInfo.lophone+'&groupId='+groupId+'&roomid='+groupId;
            var msg = '您确定要退出房间吗？'
            if(game.createType == 1){
              url= GAMEDATABASE_URL+'lottery-web/NNgame/dismiss?userId='+userInfo.lophone+'&groupId='+groupId+'&roomid='+groupId;
              msg = "您是群主，退出房间将解散本群，您确定要退出吗？"
            }
            confirmRoom(msg,url)
          })

           function confirmRoom(msg,url){
            api.confirm({
              title: '退出房间',
              msg: msg,
              buttons: ['确定', '取消']
            }, function(ret, err) {
              var index = ret.buttonIndex;
              if(index == 1){
                 console.log(url)
                missRoom(url,function(ret,err){
                  // 解散房间
                  console.log(JSON.stringify(ret));
                  // alert('返回数据')
                  if(ret.status == 1){
                    api.sendEvent({
                      name: 'createLotteryTicket',
                      extra: {
                        key1: 'value1',
                        key2: 'value2'
                      }
                    });
                    api.closeWin({});
                  }else{
                    toast("网络错误，请稍后重试")
                  }
                })
              }
            })
           }
          // 退出房间--------------------------------------


          //复制粘贴-------------------------------------
          function clicpBord(value){
            var clipBoard = api.require('clipBoard');
            clipBoard.set({
              value: value
            }, function(ret, err) {
                // alert(ret)
              if (ret) {
                toast('复制成功');
              } else {
                  toast('网络错误，请稍后重试');
              }
            });
          }
          // 键盘监听
          ListenerkeyBoard(function(data,height){
             var keyBoardStatus = data.keyBoardStatus
               if(keyBoardStatus==1){   //键盘打开
                  $(".bet").hide();
                  $(".send").show();
                  $(".tool").css("height","0px");
                  $("#convo").css("max-height",(openHeight-150)+"px");
               }else if (keyBoardStatus==0) {  //键盘关闭
                  $(".bet").show();
                  $(".send").hide();
                  $(".tool").css("height","0px");
                  $("#convo").css("max-height",($(window).height()-150)+"px");
               }
          })



       // 点击表情--------------------------------------------------------------------
       //  保存表情存放的
       var sourcePath = "widget://res/emoticons/append1";//表情存放目录
       //  调用转化路径方法 获得转换数据
       getImgsPaths(sourcePath, function (emotion) {
        emotionData = emotion;
         return emotionData;   // 返回数据
        });
       $('#Emoticons').on("click","li",function(){
                var text = $(this).attr("text");
                $("#inputText").val($("#inputText").val()+text);
        })
       // 点击表情--------------------------------------------------------------------
        // 监测网络断开---------------------------------------------------------------------------------
            // api.addEventListener({
            //       name:'offline'
            //   }, function(ret, err){
            //        $('.mask').fadeIn()
            //       alert(JSON.stringify(ret));
            //       alert('断网了');
            //   });
          // // 监测网络断开---------------------------------------------------------------------------------
          // // 监测网络连接---------------------------------------------------------------------------------
              // api.addEventListener({
              //     name:'online'
              // }, function(ret, err){
              //     $('.mask').fadeOut()
              //     alert(JSON.stringify(ret))
              //     alert('已连接到网络');
              // });
          // 监测网络连接---------------------------------------------------------------------------------
          $('.look_more').hide();

        //隐藏提示
        var shadeClose = $api.dom('.red_close');
        $api.addEvt(shadeClose, 'click', function(){
            $('.addAddressTo').hide();
        });
      }
          function redHide(){
            $('.red_send').fadeOut(500);
            $('.red_open').fadeOut(500);
            $('.look_more').fadeIn(500);
            $('.red_more').html("手慢了，红包派完了");
          }
          function closeWin(){
            api.closeWin({
            });
          }
  </script>
  </html>
